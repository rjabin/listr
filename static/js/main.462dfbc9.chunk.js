(this["webpackJsonpsimple-vc"]=this["webpackJsonpsimple-vc"]||[]).push([[0],{11:function(e,t,n){},12:function(e,t,n){},14:function(e,t,n){"use strict";n.r(t);var r=n(1),i=n.n(r),o=n(6),a=n.n(o),c=(n(11),n(2)),s=(n(12),n(3)),u=n(4);function d(e,t,n){var r=e.createShader(n);if(!r)throw new Error("Sorry! shader does not supported.");if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(r)+t);return r}function l(e,t,n){var r=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,n),e.bindBuffer(e.ARRAY_BUFFER,null),r}var f=function(){function e(t,n,r,i){Object(s.a)(this,e),this.context=void 0,this.audioNode=void 0,this.analyser=void 0,this.gain=void 0,this.requestId=void 0,this.destination=void 0,this.context=t,this.audioNode=n,this.analyser=r,this.gain=i,this.requestId=null,this.destination=this.context.createMediaStreamDestination(),this.audioNode.connect(this.destination)}return Object(u.a)(e,[{key:"startAnalysing",value:function(e){var t=this;e.clearColor(0,0,0,1);var n=function(e,t,n){var r=e.createProgram();if(!r)throw new Error("Sorry! program does not supported.");if(e.attachShader(r,t),e.attachShader(r,n),e.linkProgram(r),!e.getProgramParameter(r,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(r)+"");return r}(e,d(e,"#version 300 es\n\nprecision highp float;\n\nlayout (location = 0) in float i_value;\n\nuniform float u_length;\nuniform float u_minValue;\nuniform float u_maxValue;\n\n#define linearstep(edge0, edge1, x) max(min((x - edge0) / (edge1 - edge0), 1.0), 0.0)\n\nvoid main(void) {\n  gl_Position = vec4(\n    (float(gl_VertexID) / u_length) * 2.0 - 1.0,\n    linearstep(u_minValue, u_maxValue, i_value) * 2.0 - 1.0,\n    0.0,\n    1.0\n  );\n}\n",e.VERTEX_SHADER),d(e,"#version 300 es\n\nprecision highp float;\n\nout vec4 o_color;\n\nuniform vec3 u_color;\n\nvoid main(void) {\n  o_color = vec4(u_color, 1.0);\n}\n",e.FRAGMENT_SHADER)),r=function(e,t,n){return new Map(n.map((function(n){return[n,e.getUniformLocation(t,n)]})))}(e,n,["u_length","u_minValue","u_maxValue","u_color"]),i=new Float32Array(this.analyser.fftSize),o=new Float32Array(this.analyser.frequencyBinCount),a=l(e,i,e.DYNAMIC_DRAW),c=l(e,o,e.DYNAMIC_DRAW);this.requestId=requestAnimationFrame((function s(){e.clear(e.COLOR_BUFFER_BIT),t.analyser.getFloatTimeDomainData(i),e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferSubData(e.ARRAY_BUFFER,0,i),e.useProgram(n),e.uniform1f(r.get("u_length"),i.length),e.uniform1f(r.get("u_minValue"),-1),e.uniform1f(r.get("u_maxValue"),1),e.uniform3f(r.get("u_color"),1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINE_STRIP,0,i.length),t.analyser.getFloatFrequencyData(o),e.bindBuffer(e.ARRAY_BUFFER,c),e.bufferSubData(e.ARRAY_BUFFER,0,o),e.uniform1f(r.get("u_length"),o.length),e.uniform1f(r.get("u_minValue"),t.analyser.minDecibels),e.uniform1f(r.get("u_maxValue"),t.analyser.maxDecibels),e.uniform3f(r.get("u_color"),0,0,1),e.bindBuffer(e.ARRAY_BUFFER,c),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,1,e.FLOAT,!1,0,0),e.drawArrays(e.LINE_STRIP,0,o.length),t.requestId=requestAnimationFrame(s)}))}}]),e}();function h(e){return new Promise((function(t,n){navigator.mediaDevices.getUserMedia({audio:{deviceId:e.deviceId}}).then((function(e){var n=function(){if("function"===typeof AudioContext)return new AudioContext;throw new Error("Sorry! Web Audio not supported.")}(),r=n.createAnalyser(),i=n.createMediaStreamSource(e),o=function(e,t){var n=e.createBiquadFilter();return n.type="highpass",n.frequency.value=t,n}(n,700),a=function(e,t){var n=e.createBiquadFilter();return n.type="lowpass",n.frequency.value=t,n}(n,2e3),c=function(e,t){var n=e.createGain();return n.gain.value=t,n}(n,1);i.connect(r),r.connect(o),o.connect(a),a.connect(c),t(new f(n,c,r,c))}))}))}var v=function e(t){Object(s.a)(this,e),this.stream=void 0,this.stream=t};var m=function(){function e(){var t=this;Object(s.a)(this,e),this.mainStream=void 0,this.streams=void 0,this.recorder=void 0,this.timecodes=void 0,this.data=void 0,this.onData=void 0,this.mainStream=new MediaStream,this.streams={},this.recorder=new MediaRecorder(this.mainStream,{audioBitsPerSecond:128e3,videoBitsPerSecond:5e6}),this.timecodes=[0,0],this.onData=function(){},this.recorder.ondataavailable=function(e){t.timecodes[1]=performance.now(),t.data=e.data,t.onData((t.timecodes[1]-t.timecodes[0])/1e3)}}return Object(u.a)(e,[{key:"addStream",value:function(e){this.streams[e.id]=e}},{key:"removeStream",value:function(e){delete this.streams[e.id]}},{key:"start",value:function(){var e=this;"inactive"===this.recorder.state&&(Object.keys(this.streams).forEach((function(t){var n;null===(n=e.streams[t])||void 0===n||n.getTracks().forEach((function(t){return e.mainStream.addTrack(t)}))})),this.recorder.start(),this.timecodes[0]=performance.now())}},{key:"pause",value:function(){"recording"===this.recorder.state&&this.recorder.pause()}},{key:"resume",value:function(){"paused"===this.recorder.state&&this.recorder.resume()}},{key:"stop",value:function(){var e=this;"recording"!==this.recorder.state&&"paused"!==this.recorder.state||(this.recorder.stop(),this.recorder.stream.getTracks().forEach((function(t){return e.mainStream.removeTrack(t)})))}},{key:"split",value:function(){"recording"!==this.recorder.state&&"paused"!==this.recorder.state||this.recorder.requestData()}}]),e}(),b=function(){function e(){Object(s.a)(this,e),this.configuration=void 0,this.mainStream=void 0,this.peer=void 0,this.onLocalDescription=void 0,this.configuration={iceServers:[{urls:["stun:stun.l.google.com:19302"]}]},this.mainStream=new MediaStream;var t=new RTCPeerConnection(this.configuration);t.onnegotiationneeded=function(){console.log("onnegotiationneeded")},t.oniceconnectionstatechange=function(){console.log("oniceconnectionstatechange: "+t.iceConnectionState)},t.onicegatheringstatechange=function(){console.log("onicegatheringstatechange: "+t.iceGatheringState)},t.onicecandidate=function(e){console.log("onicecandidate")},t.onicecandidateerror=function(e){console.error(e.errorText)},this.peer=t,this.onLocalDescription=function(){}}return Object(u.a)(e,[{key:"addStream",value:function(e){var t=this;e.getTracks().forEach((function(e){return t.mainStream.addTrack(e)}))}},{key:"removeStream",value:function(e){var t=this;e.getTracks().forEach((function(e){return t.mainStream.removeTrack(e)}))}},{key:"sendOffer",value:function(){var e=this;return this.mainStream.getTracks().forEach((function(t){return e.peer.addTrack(t,e.mainStream)})),this.peer.onicecandidate=function(){e.peer.localDescription&&e.onLocalDescription(e.peer.localDescription)},this.peer.createOffer().then((function(t){return e.peer.setLocalDescription(t).then((function(){return t}))}))}},{key:"receiveOffer",value:function(e){return this.peer.setRemoteDescription(e).then((function(){return e}))}},{key:"sendAnswer",value:function(){var e=this;return this.mainStream.getTracks().forEach((function(t){return e.peer.addTrack(t,e.mainStream)})),this.peer.createAnswer().then((function(t){return e.peer.setLocalDescription(t).then((function(){return e.onLocalDescription(e.peer.localDescription)}))}))}},{key:"receiveAnswer",value:function(e){return this.peer.setRemoteDescription(e).then((function(){return e}))}},{key:"close",value:function(){this.mainStream=new MediaStream,this.peer.close(),this.peer=new RTCPeerConnection(this.configuration)}}]),e}(),g=n(0);var j=function(){var e=Object(r.useState)(),t=Object(c.a)(e,2),n=t[0],i=t[1],o=Object(r.useState)(),a=Object(c.a)(o,2),s=a[0],u=a[1],d=Object(r.useState)([]),l=Object(c.a)(d,2),f=l[0],j=l[1],p=Object(r.useState)([]),O=Object(c.a)(p,2),S=O[0],y=O[1],x=Object(r.useState)(),A=Object(c.a)(x,2),R=A[0],k=A[1],w=Object(r.useState)(),D=Object(c.a)(w,2),_=D[0],T=D[1],F=Object(r.useState)((function(){return new m})),E=Object(c.a)(F,1)[0],C=Object(r.useState)((function(){return new m})),I=Object(c.a)(C,1)[0],P=Object(r.useState)((function(){return new b})),B=Object(c.a)(P,1)[0],L=Object(r.useState)(),U=Object(c.a)(L,2),M=U[0],V=U[1],q=Object(r.useState)(),N=Object(c.a)(q,2),Y=N[0],G=N[1],J=Object(r.useRef)(null),W=Object(r.useRef)(null),H=Object(r.useRef)(null),z=Object(r.useRef)(null),K=Object(r.useRef)(null),X=Object(r.useCallback)((function(e){return null===R||void 0===R||R.context.close(),e?(console.log("selectAudioDevice: "+e.label),i(e),h(e).then((function(e){console.log("audio stream caught "+e),k(e)}))):(k(void 0),i(void 0),Promise.resolve())}),[R]),Q=Object(r.useCallback)((function(e){return e?(console.log("selectVideoDevice: "+e.label),u(e),function(e){return navigator.mediaDevices.getUserMedia({video:{deviceId:e.deviceId}}).then((function(e){return new v(e)}))}(e).then((function(e){console.log("video stream caught "+e),T(e)}))):(T(void 0),u(void 0),Promise.resolve())}),[]),Z=Object(r.useCallback)((function(){"inactive"===E.recorder.state?E.start():E.stop(),"inactive"===I.recorder.state?I.start():I.stop()}),[E,I]);return Object(r.useEffect)((function(){E.onData=function(e){var t=z.current;t&&(t.src=URL.createObjectURL(E.data),t.currentTime=e,setTimeout((function(){return t.currentTime=0}),100))},I.onData=function(e){var t=K.current;t&&(t.src=URL.createObjectURL(I.data),t.currentTime=e,setTimeout((function(){return t.currentTime=0}),100))},navigator.mediaDevices.getUserMedia({audio:!0,video:!0}).then((function(){return navigator.mediaDevices.enumerateDevices().then((function(e){return e.filter((function(e){return"audioinput"===e.kind}))})).then((function(e){return console.log("got audio devices"),j(e),e.length>0&&!n?X(e[0]):Promise.resolve()}))})).then((function(){return navigator.mediaDevices.enumerateDevices().then((function(e){return e.filter((function(e){return"videoinput"===e.kind}))})).then((function(e){return console.log("got video devices"),y(e),e.length>0&&!s?Q(e[0]):Promise.resolve()}))}))}),[]),Object(r.useEffect)((function(){return console.log("play"),W.current&&(W.current.srcObject=_?_.stream:null),R&&(B.addStream(R.destination.stream),E.addStream(R.destination.stream)),_&&(B.addStream(_.stream),E.addStream(_.stream)),function(){R&&(B.removeStream(R.destination.stream),E.removeStream(R.destination.stream)),_&&(B.removeStream(_.stream),E.removeStream(_.stream))}}),[R,B,E,_]),Object(r.useEffect)((function(){var e;null===R||void 0===R||R.startAnalysing(null===(e=J.current)||void 0===e?void 0:e.getContext("webgl2"))}),[R]),Object(r.useEffect)((function(){B.onLocalDescription=function(e){V(null===e||void 0===e?void 0:e.sdp)},B.peer.ontrack=function(e){console.log("ontrack"),console.log(e),I.addStream(e.streams[0]),H.current&&(H.current.srcObject=e.streams[0])}}),[B,I]),Object(g.jsxs)("div",{className:"App",children:[Object(g.jsx)("br",{}),Object(g.jsxs)("select",{onChange:function(e){return X(f.find((function(t){return t.deviceId===e.currentTarget.value})))},value:null===n||void 0===n?void 0:n.deviceId,children:[Object(g.jsx)("option",{}),f.map((function(e){return Object(g.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]}),Object(g.jsxs)("select",{onChange:function(e){return Q(S.find((function(t){return t.deviceId===e.currentTarget.value})))},value:null===s||void 0===s?void 0:s.deviceId,children:[Object(g.jsx)("option",{}),S.map((function(e){return Object(g.jsx)("option",{value:e.deviceId,children:e.label},e.deviceId)}))]}),Object(g.jsx)("button",{onClick:Z,children:"inactive"===E.recorder.state?"Rec":"Stop"}),Object(g.jsx)("br",{}),Object(g.jsx)("br",{}),Object(g.jsx)("canvas",{ref:J,width:800,height:100}),Object(g.jsx)("br",{}),Object(g.jsx)("video",{ref:W,width:400,height:300,style:{background:"black"},autoPlay:!0,muted:!0,playsInline:!0}),Object(g.jsx)("video",{ref:H,width:400,height:300,style:{background:"black"},autoPlay:!0,muted:!0,playsInline:!0}),Object(g.jsx)("video",{ref:z,width:400,height:300,style:{background:"black"},controls:!0,preload:"auto"}),Object(g.jsx)("video",{ref:K,width:400,height:300,style:{background:"black"},controls:!0,preload:"auto"}),Object(g.jsxs)("div",{children:[Object(g.jsx)("textarea",{value:M,readOnly:!0,rows:10,cols:50}),Object(g.jsx)("button",{onClick:function(){return B.sendOffer()},children:"\u30aa\u30d5\u30a1\u30fc\u9001\u4fe1"}),Object(g.jsx)("button",{onClick:function(){return B.sendAnswer()},children:"\u56de\u7b54\u9001\u4fe1"})]}),Object(g.jsxs)("div",{children:[Object(g.jsx)("textarea",{onChange:function(e){return G(e.currentTarget.value)},rows:10,cols:50}),Object(g.jsx)("button",{onClick:function(){return B.receiveOffer(new RTCSessionDescription({type:"offer",sdp:Y}))},children:"\u30aa\u30d5\u30a1\u30fc\u53d7\u4fe1"}),Object(g.jsx)("button",{onClick:function(){return B.receiveAnswer(new RTCSessionDescription({type:"answer",sdp:Y}))},children:"\u56de\u7b54\u53d7\u4fe1"})]}),Object(g.jsx)("div",{children:Object(g.jsx)("button",{onClick:function(){return B.close()},children:"\u5207\u65ad"})}),Object(g.jsx)("div",{children:Object(g.jsx)("textarea",{value:JSON.stringify(null===_||void 0===_?void 0:_.stream.getTracks()[0].getCapabilities()),rows:10,cols:50})})]})},p=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,15)).then((function(t){var n=t.getCLS,r=t.getFID,i=t.getFCP,o=t.getLCP,a=t.getTTFB;n(e),r(e),i(e),o(e),a(e)}))};a.a.render(Object(g.jsx)(i.a.StrictMode,{children:Object(g.jsx)(j,{})}),document.getElementById("root")),p()}},[[14,1,2]]]);
//# sourceMappingURL=main.462dfbc9.chunk.js.map